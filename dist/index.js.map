{"version":3,"file":"index.js","sources":["../src/sessions/bootstrap.tsx","../src/utils/uuid.tsx","../src/visitors/utils.tsx","../src/visitors/bootstrap.tsx","../src/settings/bootstrap.tsx","../src/context/FingerprintContext.tsx","../src/hooks/useFingerprint.tsx"],"sourcesContent":["import Cookies from 'js-cookie'\nimport { SessionState } from './types'\n\nexport const bootstrapSession = ({\n  appId,\n  setSession\n}: {\n  appId: string\n  setSession: (session: SessionState) => void\n}) => {\n  const session: SessionState = {\n    firstVisit: undefined\n  }\n\n  // If the user has never visited the site before (or has cleared their cookies)\n  // then we'll set the firstVisit boolean to true. This is also the case if the\n  // user has visited before but for some reason the App ID has been changed.\n  if (!Cookies.get('_cm') || Cookies.get('_cm') !== appId) {\n    alert('new user')\n    Cookies.set('_cm', appId, { expires: 365 })\n    session.firstVisit = true\n\n    setSession(session)\n\n    return\n  }\n\n  // If the user has visited the site before and the App ID is the same as the\n  // one stored in the cookie, then we'll set the firstVisit boolean to false.\n  if (Cookies.get('_cm') && Cookies.get('_cm') === appId) {\n    session.firstVisit = false\n\n    console.log('setting firstVisit to false')\n\n    setSession(session)\n  }\n}\n","import { validate as uuidValidate, version as uuidVersion } from 'uuid'\n\nexport const uuidValidateV4 = (uuid: string) => {\n  return uuidValidate(uuid) && uuidVersion(uuid) === 4\n}\n","import { uuidValidateV4 } from '../utils/uuid'\n\nexport const validVisitorId = (id: string) => {\n  return uuidValidateV4(id)\n}\n","import Cookies from 'js-cookie'\nimport { v4 as uuidv4 } from 'uuid'\nimport { VisitorState } from './types'\nimport { validVisitorId } from './utils'\n\nexport const bootstrapVisitor = ({\n  setVisitor\n}: {\n  setVisitor: (session: VisitorState) => void\n}) => {\n  const visitor: VisitorState = {\n    id: undefined\n  }\n\n  if (\n    !Cookies.get('_cm_id') ||\n    !validVisitorId(Cookies.get('_cm_id') as string)\n  ) {\n    const visitorId = uuidv4()\n\n    Cookies.set('_cm_id', visitorId, { expires: 365 })\n\n    visitor.id = visitorId\n\n    setVisitor(visitor)\n\n    return\n  }\n\n  if (Cookies.get('_cm_id')) {\n    visitor.id = Cookies.get('_cm_id')\n\n    setVisitor(visitor)\n  }\n}\n","export const bootstrapSettings = async () => {}\n","import React, { createContext, useEffect, useState } from 'react'\nimport { bootstrapSession } from '../sessions/bootstrap'\nimport { VisitorState } from '../visitors/types'\nimport { SessionState } from '../sessions/types'\nimport { bootstrapVisitor } from '../visitors/bootstrap'\nimport { bootstrapSettings } from '../settings/bootstrap'\n\ninterface FingerprintContextInterface {\n  session: SessionState\n  visitor: VisitorState\n}\n\nexport type FingerprintProviderProps = {\n  appId: string\n  children: React.ReactNode\n  debug?: boolean\n}\n\nexport type FingerprintState = {\n  session: SessionState\n  visitor: VisitorState\n}\n\nconst defaultFingerprintState: FingerprintState = {\n  session: {\n    firstVisit: undefined\n  },\n  visitor: {\n    id: undefined\n  }\n}\n\nexport const FingerprintProvider = (props: FingerprintProviderProps) => {\n  const { appId, children, debug } = props\n  const [booted, setBooted] = useState(false)\n  const [fingerprint, setFingerprint] = useState<FingerprintState>(\n    defaultFingerprintState\n  )\n\n  const setSession = (session: SessionState) => {\n    console.log('setting session', session, fingerprint)\n    setFingerprint({\n      ...fingerprint,\n      session\n    })\n  }\n\n  const setVisitor = (visitor: VisitorState) => {\n    console.log('setting visitor', visitor, fingerprint)\n    setFingerprint({\n      ...fingerprint,\n      visitor\n    })\n  }\n\n  useEffect(() => {\n    if (!appId) {\n      throw new Error('C&M Fingerprint: appId is required')\n    }\n\n    if (booted) {\n      return\n    }\n\n    const performBoot = async () => {\n      await bootstrapSettings()\n\n      await bootstrapSession({\n        appId,\n        setSession\n      })\n\n      await bootstrapVisitor({\n        setVisitor\n      })\n\n      if (debug) {\n        console.log('C&M Fingerprint Booted')\n      }\n\n      setBooted(true)\n    }\n\n    performBoot()\n  }, [])\n\n  useEffect(() => {\n    if (debug) {\n      console.log('C&M Fingerprint: ', fingerprint)\n    }\n  }, [fingerprint])\n\n  return (\n    <FingerprintContext.Provider\n      value={{\n        ...fingerprint\n      }}\n    >\n      {children}\n    </FingerprintContext.Provider>\n  )\n}\n\nexport const FingerprintContext = createContext<FingerprintContextInterface>({\n  ...defaultFingerprintState\n})\n","import { useContext } from 'react'\nimport { FingerprintContext } from '../context/FingerprintContext'\n\nexport const useFingerprint = () => {\n  const { session } = useContext(FingerprintContext)\n\n  return {\n    session\n  }\n}\n"],"names":["bootstrapSession","_ref","appId","setSession","session","firstVisit","undefined","Cookies","get","alert","set","expires","console","log","uuidValidateV4","uuid","uuidValidate","uuidVersion","validVisitorId","id","bootstrapVisitor","setVisitor","visitor","visitorId","uuidv4","bootstrapSettings","defaultFingerprintState","FingerprintProvider","props","children","debug","_useState","useState","booted","setBooted","_useState2","fingerprint","setFingerprint","_extends","useEffect","Error","performBoot","then","Promise","resolve","e","reject","React","FingerprintContext","Provider","value","createContext","useFingerprint","_useContext","useContext"],"mappings":"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"}
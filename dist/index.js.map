{"version":3,"file":"index.js","sources":["../src/context/LoggingContext.tsx","../src/hooks/useCollector.ts","../src/context/CollectorContext.tsx","../src/sessions/bootstrap.tsx","../src/utils/uuid.tsx","../src/visitors/utils.tsx","../src/visitors/bootstrap.tsx","../src/context/VisitorContext.tsx","../src/context/FingerprintContext.tsx"],"sourcesContent":["import React, { createContext, useContext } from 'react'\n\nexport type LoggingProviderProps = {\n  debug?: boolean\n  children?: React.ReactNode\n}\n\nexport type LoggingContextInterface = {\n  log: (...message: any) => void\n  warn: (...message: any) => void\n  error: (...message: any) => void\n  info: (...message: any) => void\n}\n\n// @todo have this provider log pre-boot and post-boot with\n// context around the App ID, session, visitor, etc.\nexport const LoggingProvider = ({ debug, children }: LoggingProviderProps) => {\n  const log = (...message: any) => {\n    if (debug) {\n      console.log(...message)\n    }\n  }\n\n  const warn = (...message: any) => {\n    if (debug) {\n      console.warn(...message)\n    }\n  }\n\n  const error = (...message: any) => {\n    if (debug) {\n      console.error(...message)\n    }\n\n    throw new Error(...message)\n  }\n\n  const info = (...message: any) => {\n    if (debug) {\n      console.info(...message)\n    }\n  }\n\n  return (\n    <LoggingContext.Provider\n      value={{\n        log,\n        warn,\n        error,\n        info\n      }}\n    >\n      {children}\n    </LoggingContext.Provider>\n  )\n}\n\nexport const LoggingContext = createContext<LoggingContextInterface>({\n  log: () => {},\n  warn: () => {},\n  error: () => {},\n  info: () => {}\n})\n\nexport const useLogging = () => {\n  return useContext(LoggingContext)\n}\n","import { useMutation } from '@tanstack/react-query'\n// import axios, { AxiosResponse } from 'axios'\n\n// type CollectorUpdate = {}\n\n// export const useCollector = () => {\n//   // @ts-ignore\n//   const api = axios.create({\n//     // @todo up date this to use env\n//     baseURL: 'http://localhost:3000/api',\n//     headers: {\n//       'Content-Type': 'application/json',\n//       Accept: 'application/json'\n//     }\n//   })\n\n//   return useMutation<\n//     AxiosResponse<any, any>,\n//     unknown,\n//     CollectorUpdate,\n//     unknown\n//   >((data: CollectorUpdate) => api.patch(`/collect`, data), {\n//     onSuccess: () => {\n//       // console.log(response.data)\n//     }\n//   })\n// }\n\n// Local implementation of collector which does not make a network request\nexport const useCollector = () => {\n  return useMutation<unknown, unknown, any, unknown>(\n    (data: any) => {\n      console.log(data)\n      return data\n    },\n    {\n      onSuccess: () => {\n        // console.log(response.data)\n      }\n    }\n  )\n}\n","import React, { createContext, useEffect } from 'react'\nimport { useCollector } from '../hooks/useCollector'\nimport { useLogging } from './LoggingContext'\n\nexport type CollectorProviderProps = {}\n\nexport type CollectorContextInterface = {}\n\nexport const CollectorProvider = () => {\n  const { log } = useLogging()\n  // const { fingerprint } = useFingerprint()\n  const { mutateAsync: collect } = useCollector()\n\n  // @todo this should be invoked when booted\n  // and then on any window page URL changes.\n  useEffect(() => {\n    log('CollectorProvider: collecting data')\n\n    collect({\n      type: 'pageview',\n      data: {}\n    })\n      .then((response) => {\n        console.warn('sent collect data, retrieved:', response)\n      })\n      .catch((error) => {\n        console.error('failed to store collected data', error)\n      })\n\n    log('CollectorProvider: collected data')\n  }, [])\n\n  return (\n    <CollectorContext.Provider value={{}}>\n      {/* {fingerprint.session.firstVisit === true\n        ? invokeFirstVisit()\n        : invokeReturningVisit()} */}\n    </CollectorContext.Provider>\n  )\n}\n\nexport const CollectorContext = createContext<CollectorContextInterface>({})\n","import Cookies from 'js-cookie'\nimport { SessionState } from './types'\n\nexport const bootstrapSession = ({\n  appId,\n  setSession\n}: {\n  appId: string\n  setSession: (session: SessionState) => void\n}) => {\n  const session: SessionState = {\n    firstVisit: undefined\n  }\n\n  // If the user has never visited the site before (or has cleared their cookies)\n  // then we'll set the firstVisit boolean to true. This is also the case if the\n  // user has visited before but for some reason the App ID has been changed.\n  if (!Cookies.get('_cm') || Cookies.get('_cm') !== appId) {\n    Cookies.set('_cm', appId, { expires: 365 })\n    session.firstVisit = true\n\n    setSession(session)\n\n    return\n  }\n\n  // If the user has visited the site before and the App ID is the same as the\n  // one stored in the cookie, then we'll set the firstVisit boolean to false.\n  if (Cookies.get('_cm') && Cookies.get('_cm') === appId) {\n    session.firstVisit = false\n\n    console.log('setting firstVisit to false')\n\n    setSession(session)\n  }\n}\n","import { validate as uuidValidate, version as uuidVersion } from 'uuid'\n\nexport const uuidValidateV4 = (uuid: string) => {\n  return uuidValidate(uuid) && uuidVersion(uuid) === 4\n}\n","import { uuidValidateV4 } from '../utils/uuid'\n\nexport const validVisitorId = (id: string) => {\n  return uuidValidateV4(id)\n}\n","import Cookies from 'js-cookie'\nimport { v4 as uuidv4 } from 'uuid'\nimport { VisitorState } from './types'\nimport { validVisitorId } from './utils'\n\nexport const bootstrapVisitor = ({\n  setVisitor\n}: {\n  setVisitor: (session: VisitorState) => void\n}) => {\n  const visitor: VisitorState = {\n    id: undefined\n  }\n\n  if (\n    !Cookies.get('_cm_id') ||\n    !validVisitorId(Cookies.get('_cm_id') as string)\n  ) {\n    const visitorId = uuidv4()\n\n    Cookies.set('_cm_id', visitorId, { expires: 365 })\n\n    visitor.id = visitorId\n\n    setVisitor(visitor)\n\n    return\n  }\n\n  if (Cookies.get('_cm_id')) {\n    visitor.id = Cookies.get('_cm_id')\n\n    setVisitor(visitor)\n  }\n}\n","import React, { createContext, useEffect, useState } from 'react'\nimport { SessionState } from '../sessions/types'\nimport { VisitorState } from '../visitors/types'\nimport { useLogging } from './LoggingContext'\nimport { bootstrapSession } from '../sessions/bootstrap'\nimport { bootstrapVisitor } from '../visitors/bootstrap'\nimport { useFingerprint } from './FingerprintContext'\n\nexport type VisitorProviderProps = {\n  children?: React.ReactNode\n}\n\nexport type VisitorContextInterface = {}\n\nexport const VisitorProvider = ({ children }: VisitorProviderProps) => {\n  const { appId, booted } = useFingerprint()\n  const { log } = useLogging()\n  const [session, setSession] = useState<SessionState>({})\n  const [visitor, setVisitor] = useState<VisitorState>({})\n\n  console.log('VisitorProvider')\n\n  useEffect(() => {\n    if (!booted) {\n      log('VisitorProvider: not booted')\n      return\n    }\n\n    log('VisitorProvider: booting')\n\n    const boot = async () => {\n      await bootstrapSession({\n        appId,\n        setSession\n      })\n\n      await bootstrapVisitor({\n        setVisitor\n      })\n    }\n\n    boot()\n\n    log('VisitorProvider: booted', session, visitor)\n  }, [appId, booted])\n\n  return (\n    <VisitorContext.Provider value={{}}>{children}</VisitorContext.Provider>\n  )\n}\n\nexport const VisitorContext = createContext<VisitorContextInterface>({})\n","import React, { createContext, useContext, useEffect, useState } from 'react'\nimport { QueryClient, QueryClientProvider } from '@tanstack/react-query'\nimport { LoggingProvider } from './LoggingContext'\nimport { CollectorProvider } from './CollectorContext'\nimport { VisitorProvider } from './VisitorContext'\n\nconst queryClient = new QueryClient()\n\nexport type FingerprintProviderProps = {\n  appId?: string\n  children?: React.ReactNode\n  debug?: boolean\n}\n\n// @todo split this into multiple providers, FingerprintProvider should\n// only bootstrap the app.\nexport const FingerprintProvider = (props: FingerprintProviderProps) => {\n  const { appId, debug } = props\n  const [booted, setBooted] = useState(false)\n\n  useEffect(() => {\n    if (!appId) {\n      throw new Error('C&M Fingerprint: appId is required')\n    }\n\n    if (booted) {\n      return\n    }\n\n    const performBoot = async () => {\n      // @todo this should be invoked when booted.\n      // It will call out to the API to confirm the\n      // appId is valid and return the app configuration.\n      setBooted(true)\n    }\n\n    performBoot()\n  }, [])\n\n  if (!appId) {\n    return null\n  }\n\n  return (\n    <LoggingProvider debug={debug}>\n      <QueryClientProvider client={queryClient}>\n        <FingerprintContext.Provider\n          value={{\n            appId,\n            booted\n          }}\n        >\n          <VisitorProvider>\n            <CollectorProvider />\n          </VisitorProvider>\n        </FingerprintContext.Provider>\n      </QueryClientProvider>\n    </LoggingProvider>\n  )\n}\n\nexport interface FingerprintContextInterface {\n  appId: string\n  booted: boolean\n}\n\nconst defaultFingerprintState: FingerprintContextInterface = {\n  appId: '',\n  booted: false\n}\n\nexport const FingerprintContext = createContext<FingerprintContextInterface>({\n  ...defaultFingerprintState\n})\n\nexport const useFingerprint = () => {\n  return useContext(FingerprintContext)\n}\n"],"names":["LoggingProvider","_ref","debug","children","log","_console","console","apply","arguments","warn","_console2","error","message","Array","_len","_key","_console3","_construct","Error","info","_console4","React","LoggingContext","Provider","value","createContext","useLogging","useContext","useCollector","useMutation","data","onSuccess","CollectorProvider","_useLogging","_useCollector","collect","mutateAsync","useEffect","type","then","response","CollectorContext","bootstrapSession","appId","setSession","session","firstVisit","undefined","Cookies","get","set","expires","uuidValidateV4","uuid","uuidValidate","uuidVersion","validVisitorId","id","bootstrapVisitor","setVisitor","visitor","visitorId","uuidv4","VisitorProvider","_useFingerprint","useFingerprint","booted","_useState","useState","_useState2","boot","Promise","resolve","e","reject","VisitorContext","queryClient","QueryClient","FingerprintProvider","props","setBooted","performBoot","QueryClientProvider","client","FingerprintContext","defaultFingerprintState","_extends"],"mappings":"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"}
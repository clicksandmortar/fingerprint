{"version":3,"file":"index.modern.js","sources":["../src/context/LoggingContext.tsx","../src/hooks/useCollector.ts","../src/context/CollectorContext.tsx","../src/sessions/bootstrap.tsx","../src/utils/uuid.tsx","../src/visitors/utils.tsx","../src/visitors/bootstrap.tsx","../src/context/VisitorContext.tsx","../src/context/FingerprintContext.tsx"],"sourcesContent":["import React, { createContext, useContext } from 'react'\n\nexport type LoggingProviderProps = {\n  debug?: boolean\n  children?: React.ReactNode\n}\n\nexport type LoggingContextInterface = {\n  log: (...message: any) => void\n  warn: (...message: any) => void\n  error: (...message: any) => void\n  info: (...message: any) => void\n}\n\n// @todo have this provider log pre-boot and post-boot with\n// context around the App ID, session, visitor, etc.\nexport const LoggingProvider = ({ debug, children }: LoggingProviderProps) => {\n  const log = (...message: any) => {\n    if (debug) {\n      console.log(...message)\n    }\n  }\n\n  const warn = (...message: any) => {\n    if (debug) {\n      console.warn(...message)\n    }\n  }\n\n  const error = (...message: any) => {\n    if (debug) {\n      console.error(...message)\n    }\n\n    throw new Error(...message)\n  }\n\n  const info = (...message: any) => {\n    if (debug) {\n      console.info(...message)\n    }\n  }\n\n  return (\n    <LoggingContext.Provider\n      value={{\n        log,\n        warn,\n        error,\n        info\n      }}\n    >\n      {children}\n    </LoggingContext.Provider>\n  )\n}\n\nexport const LoggingContext = createContext<LoggingContextInterface>({\n  log: () => {},\n  warn: () => {},\n  error: () => {},\n  info: () => {}\n})\n\nexport const useLogging = () => {\n  return useContext(LoggingContext)\n}\n","import { useMutation } from '@tanstack/react-query'\n// import axios, { AxiosResponse } from 'axios'\n\n// type CollectorUpdate = {}\n\n// export const useCollector = () => {\n//   // @ts-ignore\n//   const api = axios.create({\n//     // @todo up date this to use env\n//     baseURL: 'http://localhost:3000/api',\n//     headers: {\n//       'Content-Type': 'application/json',\n//       Accept: 'application/json'\n//     }\n//   })\n\n//   return useMutation<\n//     AxiosResponse<any, any>,\n//     unknown,\n//     CollectorUpdate,\n//     unknown\n//   >((data: CollectorUpdate) => api.patch(`/collect`, data), {\n//     onSuccess: () => {\n//       // console.log(response.data)\n//     }\n//   })\n// }\n\n// Local implementation of collector which does not make a network request\nexport const useCollector = () => {\n  return useMutation<unknown, unknown, any, unknown>(\n    (data: any) => {\n      console.log(data)\n      return data\n    },\n    {\n      onSuccess: () => {\n        // console.log(response.data)\n      }\n    }\n  )\n}\n","import React, { createContext, useEffect } from 'react'\nimport { useCollector } from '../hooks/useCollector'\nimport { useLogging } from './LoggingContext'\n\nexport type CollectorProviderProps = {}\n\nexport type CollectorContextInterface = {}\n\nexport const CollectorProvider = () => {\n  const { log } = useLogging()\n  // const { fingerprint } = useFingerprint()\n  const { mutateAsync: collect } = useCollector()\n\n  // @todo this should be invoked when booted\n  // and then on any window page URL changes.\n  useEffect(() => {\n    log('CollectorProvider: collecting data')\n\n    collect({\n      type: 'pageview',\n      data: {}\n    })\n      .then((response) => {\n        console.warn('sent collect data, retrieved:', response)\n      })\n      .catch((error) => {\n        console.error('failed to store collected data', error)\n      })\n\n    log('CollectorProvider: collected data')\n  }, [])\n\n  return (\n    <CollectorContext.Provider value={{}}>\n      {/* {fingerprint.session.firstVisit === true\n        ? invokeFirstVisit()\n        : invokeReturningVisit()} */}\n    </CollectorContext.Provider>\n  )\n}\n\nexport const CollectorContext = createContext<CollectorContextInterface>({})\n","import Cookies from 'js-cookie'\nimport { SessionState } from './types'\n\nexport const bootstrapSession = ({\n  appId,\n  setSession\n}: {\n  appId: string\n  setSession: (session: SessionState) => void\n}) => {\n  const session: SessionState = {\n    firstVisit: undefined\n  }\n\n  // If the user has never visited the site before (or has cleared their cookies)\n  // then we'll set the firstVisit boolean to true. This is also the case if the\n  // user has visited before but for some reason the App ID has been changed.\n  if (!Cookies.get('_cm') || Cookies.get('_cm') !== appId) {\n    Cookies.set('_cm', appId, { expires: 365 })\n    session.firstVisit = true\n\n    setSession(session)\n\n    return\n  }\n\n  // If the user has visited the site before and the App ID is the same as the\n  // one stored in the cookie, then we'll set the firstVisit boolean to false.\n  if (Cookies.get('_cm') && Cookies.get('_cm') === appId) {\n    session.firstVisit = false\n\n    console.log('setting firstVisit to false')\n\n    setSession(session)\n  }\n}\n","import { validate as uuidValidate, version as uuidVersion } from 'uuid'\n\nexport const uuidValidateV4 = (uuid: string) => {\n  return uuidValidate(uuid) && uuidVersion(uuid) === 4\n}\n","import { uuidValidateV4 } from '../utils/uuid'\n\nexport const validVisitorId = (id: string) => {\n  return uuidValidateV4(id)\n}\n","import Cookies from 'js-cookie'\nimport { v4 as uuidv4 } from 'uuid'\nimport { VisitorState } from './types'\nimport { validVisitorId } from './utils'\n\nexport const bootstrapVisitor = ({\n  setVisitor\n}: {\n  setVisitor: (session: VisitorState) => void\n}) => {\n  const visitor: VisitorState = {\n    id: undefined\n  }\n\n  if (\n    !Cookies.get('_cm_id') ||\n    !validVisitorId(Cookies.get('_cm_id') as string)\n  ) {\n    const visitorId = uuidv4()\n\n    Cookies.set('_cm_id', visitorId, { expires: 365 })\n\n    visitor.id = visitorId\n\n    setVisitor(visitor)\n\n    return\n  }\n\n  if (Cookies.get('_cm_id')) {\n    visitor.id = Cookies.get('_cm_id')\n\n    setVisitor(visitor)\n  }\n}\n","import React, { createContext, useEffect, useState } from 'react'\nimport { SessionState } from '../sessions/types'\nimport { VisitorState } from '../visitors/types'\nimport { useLogging } from './LoggingContext'\nimport { bootstrapSession } from '../sessions/bootstrap'\nimport { bootstrapVisitor } from '../visitors/bootstrap'\nimport { useFingerprint } from './FingerprintContext'\n\nexport type VisitorProviderProps = {\n  children?: React.ReactNode\n}\n\nexport type VisitorContextInterface = {}\n\nexport const VisitorProvider = ({ children }: VisitorProviderProps) => {\n  const { appId, booted } = useFingerprint()\n  const { log } = useLogging()\n  const [session, setSession] = useState<SessionState>({})\n  const [visitor, setVisitor] = useState<VisitorState>({})\n\n  console.log('VisitorProvider')\n\n  useEffect(() => {\n    if (!booted) {\n      log('VisitorProvider: not booted')\n      return\n    }\n\n    log('VisitorProvider: booting')\n\n    const boot = async () => {\n      await bootstrapSession({\n        appId,\n        setSession\n      })\n\n      await bootstrapVisitor({\n        setVisitor\n      })\n    }\n\n    boot()\n\n    log('VisitorProvider: booted', session, visitor)\n  }, [appId, booted])\n\n  return (\n    <VisitorContext.Provider value={{}}>{children}</VisitorContext.Provider>\n  )\n}\n\nexport const VisitorContext = createContext<VisitorContextInterface>({})\n","import React, { createContext, useContext, useEffect, useState } from 'react'\nimport { QueryClient, QueryClientProvider } from '@tanstack/react-query'\nimport { LoggingProvider } from './LoggingContext'\nimport { CollectorProvider } from './CollectorContext'\nimport { VisitorProvider } from './VisitorContext'\n\nconst queryClient = new QueryClient()\n\nexport type FingerprintProviderProps = {\n  appId?: string\n  children?: React.ReactNode\n  debug?: boolean\n}\n\n// @todo split this into multiple providers, FingerprintProvider should\n// only bootstrap the app.\nexport const FingerprintProvider = (props: FingerprintProviderProps) => {\n  const { appId, debug } = props\n  const [booted, setBooted] = useState(false)\n\n  useEffect(() => {\n    if (!appId) {\n      throw new Error('C&M Fingerprint: appId is required')\n    }\n\n    if (booted) {\n      return\n    }\n\n    const performBoot = async () => {\n      // @todo this should be invoked when booted.\n      // It will call out to the API to confirm the\n      // appId is valid and return the app configuration.\n      setBooted(true)\n    }\n\n    performBoot()\n  }, [])\n\n  if (!appId) {\n    return null\n  }\n\n  return (\n    <LoggingProvider debug={debug}>\n      <QueryClientProvider client={queryClient}>\n        <FingerprintContext.Provider\n          value={{\n            appId,\n            booted\n          }}\n        >\n          <VisitorProvider>\n            <CollectorProvider />\n          </VisitorProvider>\n        </FingerprintContext.Provider>\n      </QueryClientProvider>\n    </LoggingProvider>\n  )\n}\n\nexport interface FingerprintContextInterface {\n  appId: string\n  booted: boolean\n}\n\nconst defaultFingerprintState: FingerprintContextInterface = {\n  appId: '',\n  booted: false\n}\n\nexport const FingerprintContext = createContext<FingerprintContextInterface>({\n  ...defaultFingerprintState\n})\n\nexport const useFingerprint = () => {\n  return useContext(FingerprintContext)\n}\n"],"names":["LoggingProvider","debug","children","log","message","console","warn","error","Error","info","React","LoggingContext","Provider","value","createContext","useLogging","useContext","useCollector","useMutation","data","onSuccess","CollectorProvider","mutateAsync","collect","useEffect","type","then","response","catch","CollectorContext","bootstrapSession","appId","setSession","session","firstVisit","undefined","Cookies","get","set","expires","uuidValidateV4","uuid","uuidValidate","uuidVersion","validVisitorId","id","bootstrapVisitor","setVisitor","visitor","visitorId","uuidv4","VisitorProvider","booted","useFingerprint","useState","boot","VisitorContext","queryClient","QueryClient","FingerprintProvider","props","setBooted","performBoot","QueryClientProvider","client","FingerprintContext","defaultFingerprintState"],"mappings":"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"}
{"version":3,"file":"index.modern.js","sources":["../src/sessions/bootstrap.tsx","../src/utils/uuid.tsx","../src/visitors/utils.tsx","../src/visitors/bootstrap.tsx","../src/settings/bootstrap.tsx","../src/context/FingerprintContext.tsx","../src/hooks/useFingerprint.tsx"],"sourcesContent":["import Cookies from 'js-cookie'\nimport { SessionState } from './types'\n\nexport const bootstrapSession = ({\n  appId,\n  setSession\n}: {\n  appId: string\n  setSession: (session: SessionState) => void\n}) => {\n  const session: SessionState = {\n    firstVisit: undefined\n  }\n\n  // If the user has never visited the site before (or has cleared their cookies)\n  // then we'll set the firstVisit boolean to true. This is also the case if the\n  // user has visited before but for some reason the App ID has been changed.\n  if (!Cookies.get('_cm') || Cookies.get('_cm') !== appId) {\n    alert('new user')\n    Cookies.set('_cm', appId, { expires: 365 })\n    session.firstVisit = true\n\n    setSession(session)\n\n    return\n  }\n\n  // If the user has visited the site before and the App ID is the same as the\n  // one stored in the cookie, then we'll set the firstVisit boolean to false.\n  if (Cookies.get('_cm') && Cookies.get('_cm') === appId) {\n    session.firstVisit = false\n\n    console.log('setting firstVisit to false')\n\n    setSession(session)\n  }\n}\n","import { validate as uuidValidate, version as uuidVersion } from 'uuid'\n\nexport const uuidValidateV4 = (uuid: string) => {\n  return uuidValidate(uuid) && uuidVersion(uuid) === 4\n}\n","import { uuidValidateV4 } from '../utils/uuid'\n\nexport const validVisitorId = (id: string) => {\n  return uuidValidateV4(id)\n}\n","import Cookies from 'js-cookie'\nimport { v4 as uuidv4 } from 'uuid'\nimport { VisitorState } from './types'\nimport { validVisitorId } from './utils'\n\nexport const bootstrapVisitor = ({\n  setVisitor\n}: {\n  setVisitor: (session: VisitorState) => void\n}) => {\n  const visitor: VisitorState = {\n    id: undefined\n  }\n\n  if (\n    !Cookies.get('_cm_id') ||\n    !validVisitorId(Cookies.get('_cm_id') as string)\n  ) {\n    const visitorId = uuidv4()\n\n    Cookies.set('_cm_id', visitorId, { expires: 365 })\n\n    visitor.id = visitorId\n\n    setVisitor(visitor)\n\n    return\n  }\n\n  if (Cookies.get('_cm_id')) {\n    visitor.id = Cookies.get('_cm_id')\n\n    setVisitor(visitor)\n  }\n}\n","export const bootstrapSettings = async () => {}\n","import React, { createContext, useEffect, useState } from 'react'\nimport { bootstrapSession } from '../sessions/bootstrap'\nimport { VisitorState } from '../visitors/types'\nimport { SessionState } from '../sessions/types'\nimport { bootstrapVisitor } from '../visitors/bootstrap'\nimport { bootstrapSettings } from '../settings/bootstrap'\n\ninterface FingerprintContextInterface {\n  session: SessionState\n  visitor: VisitorState\n}\n\nexport type FingerprintProviderProps = {\n  appId: string\n  children: React.ReactNode\n  debug?: boolean\n}\n\nexport type FingerprintState = {\n  session: SessionState\n  visitor: VisitorState\n}\n\nconst defaultFingerprintState: FingerprintState = {\n  session: {\n    firstVisit: undefined\n  },\n  visitor: {\n    id: undefined\n  }\n}\n\nexport const FingerprintProvider = (props: FingerprintProviderProps) => {\n  const { appId, children, debug } = props\n  const [booted, setBooted] = useState(false)\n  const [fingerprint, setFingerprint] = useState<FingerprintState>(\n    defaultFingerprintState\n  )\n\n  const setSession = (session: SessionState) => {\n    console.log('setting session', session, fingerprint)\n    setFingerprint({\n      ...fingerprint,\n      session\n    })\n  }\n\n  const setVisitor = (visitor: VisitorState) => {\n    console.log('setting visitor', visitor, fingerprint)\n    setFingerprint({\n      ...fingerprint,\n      visitor\n    })\n  }\n\n  useEffect(() => {\n    if (!appId) {\n      throw new Error('C&M Fingerprint: appId is required')\n    }\n\n    if (booted) {\n      return\n    }\n\n    const performBoot = async () => {\n      await bootstrapSettings()\n\n      await bootstrapSession({\n        appId,\n        setSession\n      })\n\n      await bootstrapVisitor({\n        setVisitor\n      })\n\n      if (debug) {\n        console.log('C&M Fingerprint Booted')\n      }\n\n      setBooted(true)\n    }\n\n    performBoot()\n  }, [])\n\n  useEffect(() => {\n    if (debug) {\n      console.log('C&M Fingerprint: ', fingerprint)\n    }\n  }, [fingerprint])\n\n  return (\n    <FingerprintContext.Provider\n      value={{\n        ...fingerprint\n      }}\n    >\n      {children}\n    </FingerprintContext.Provider>\n  )\n}\n\nexport const FingerprintContext = createContext<FingerprintContextInterface>({\n  ...defaultFingerprintState\n})\n","import { useContext } from 'react'\nimport { FingerprintContext } from '../context/FingerprintContext'\n\nexport const useFingerprint = () => {\n  const { session } = useContext(FingerprintContext)\n\n  return {\n    session\n  }\n}\n"],"names":["bootstrapSession","appId","setSession","session","firstVisit","undefined","Cookies","get","alert","set","expires","console","log","uuidValidateV4","uuid","uuidValidate","uuidVersion","validVisitorId","id","bootstrapVisitor","setVisitor","visitor","visitorId","uuidv4","bootstrapSettings","defaultFingerprintState","FingerprintProvider","props","children","debug","booted","setBooted","useState","fingerprint","setFingerprint","useEffect","Error","performBoot","React","FingerprintContext","Provider","value","createContext","useFingerprint","useContext"],"mappings":"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"}